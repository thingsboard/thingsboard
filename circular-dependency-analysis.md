# Circular Dependency Analysis: Injection vs Deletion Conflicts

## Executive Summary

This analysis reveals the root cause of circular dependency issues in ThingsBoard: **conflicts between dependency injection points and deletion/cleanup points** during the build process. The issue occurs when modules require dependencies that are being cleaned up or regenerated by other modules in the same build cycle.

## Critical Circular Dependency Chain

### **The Core Circular Dependency:**

```
common/message → common/proto → common/edge-api → common/message
     ↓              ↓              ↓              ↓
  tbmsg.proto   queue.proto   edge.proto    (imports tbmsg.proto)
```

### **Detailed Dependency Flow:**

1. **`common/message`** generates `tbmsg.proto` classes
2. **`common/proto`** imports `tbmsg.proto` and generates `queue.proto` classes  
3. **`common/edge-api`** imports `queue.proto` and generates `edge.proto` classes
4. **`common/edge-api`** also has a copy of `queue.proto` that imports `tbmsg.proto`

## Build Order Analysis

### **Current Build Order (Common POM):**
```xml
<modules>
    <module>data</module>            <!-- ✅ Foundation -->
    <module>util</module>            <!-- ✅ Foundation -->
    <module>message</module>         <!-- ✅ Generates tbmsg.proto -->
    <module>proto</module>           <!-- ❌ NEEDS tbmsg.proto from message -->
    <module>edge-api</module>        <!-- ❌ NEEDS queue.proto from proto -->
    <module>actor</module>           <!-- ✅ Independent -->
    <module>queue</module>           <!-- ❌ NEEDS proto -->
    <module>transport</module>       <!-- ❌ NEEDS proto -->
    <module>dao-api</module>         <!-- ✅ Independent -->
    <module>cluster-api</module>     <!-- ❌ NEEDS proto -->
    <module>stats</module>           <!-- ✅ Independent -->
    <module>cache</module>           <!-- ❌ NEEDS proto -->
    <module>coap-server</module>     <!-- ✅ Independent -->
    <module>version-control</module> <!-- ✅ Independent -->
    <module>script</module>          <!-- ✅ Independent -->
    <module>edqs</module>            <!-- ❌ NEEDS proto -->
    <module>discovery-api</module>   <!-- ❌ NEEDS proto -->
</modules>
```

### **Dependency Injection Points (Where Dependencies Are Required):**

| Module | Requires | Injection Point | Status |
|--------|----------|-----------------|--------|
| `common/proto` | `tbmsg.proto` from `message` | Protobuf compilation | ❌ **CONFLICT** |
| `common/edge-api` | `queue.proto` from `proto` | Protobuf compilation | ❌ **CONFLICT** |
| `common/queue` | `proto` classes | Java compilation | ❌ **CONFLICT** |
| `common/transport` | `proto` classes | Java compilation | ❌ **CONFLICT** |
| `common/cluster-api` | `proto` classes | Java compilation | ❌ **CONFLICT** |
| `common/cache` | `proto` classes | Java compilation | ❌ **CONFLICT** |
| `common/edqs` | `proto` classes | Java compilation | ❌ **CONFLICT** |
| `common/discovery-api` | `proto` classes | Java compilation | ❌ **CONFLICT** |

### **Dependency Deletion Points (Where Dependencies Are Cleaned):**

| Module | Cleans/Regenerates | Deletion Point | Status |
|--------|-------------------|----------------|--------|
| `common/message` | `tbmsg.proto` classes | `target/generated-sources/` | ❌ **CONFLICT** |
| `common/proto` | `queue.proto` classes | `target/generated-sources/` | ❌ **CONFLICT** |
| `common/edge-api` | `edge.proto` classes | `target/generated-sources/` | ❌ **CONFLICT** |

## The Injection vs Deletion Conflict

### **Problem Scenario:**

1. **Build starts** with `mvn clean install`
2. **`common/message`** builds first, generates `tbmsg.proto` classes
3. **`common/proto`** tries to build, needs `tbmsg.proto` classes
4. **Protobuf plugin** in `common/proto` tries to clean up its target directory
5. **Cleanup process** may interfere with `tbmsg.proto` classes from `message`
6. **Build fails** with "File not found" or "Unable to clean up" errors

### **Root Cause Analysis:**

The conflict occurs because:

1. **Multiple modules** are trying to access the same protobuf files
2. **Protobuf plugin cleanup** is interfering with cross-module dependencies
3. **Build order** doesn't account for protobuf file sharing
4. **Temporary file management** is not coordinated between modules

## Specific Conflict Points

### **Conflict 1: tbmsg.proto Sharing**
- **Injection Point**: `common/proto` needs `tbmsg.proto` from `common/message`
- **Deletion Point**: `common/proto` protobuf plugin cleans up temporary files
- **Conflict**: Plugin cleanup interferes with `tbmsg.proto` access

### **Conflict 2: queue.proto Sharing**
- **Injection Point**: `common/edge-api` needs `queue.proto` from `common/proto`
- **Deletion Point**: `common/edge-api` protobuf plugin cleans up temporary files
- **Conflict**: Plugin cleanup interferes with `queue.proto` access

### **Conflict 3: Generated Class Sharing**
- **Injection Point**: Multiple modules need generated protobuf classes
- **Deletion Point**: Each module's protobuf plugin cleans its own target
- **Conflict**: Cleanup in one module affects others

## Current Mitigation Strategies

### **✅ Applied Fixes:**

1. **Build Order Optimization**
   - `message` → `proto` → `edge-api` sequence maintained
   - Dependencies built before dependents

2. **Protobuf Plugin Configuration**
   - `checkStaleness: false` - Prevents unnecessary regeneration
   - `clearOutputDirectory: false` - Prevents cleanup conflicts

3. **Temporary File Copying**
   - `tbmsg.proto` copied to `common/edge-api/src/main/proto/`
   - `queue.proto` copied to `common/edge-api/src/main/proto/`

### **⚠️ Remaining Issues:**

1. **Plugin Cleanup Failures**
   - Even with `clearOutputDirectory: false`, cleanup still fails
   - Plugin version 0.6.1 has known issues

2. **Temporary File Conflicts**
   - Multiple modules accessing same protobuf files
   - Race conditions during parallel builds

## Recommended Solutions

### **Immediate Fixes (High Priority):**

1. **Upgrade Protobuf Plugin**
   ```xml
   <version>0.6.1</version> → <version>0.6.2</version>
   ```

2. **Implement Shared Protobuf Directory**
   - Create `shared-proto-deps/` directory
   - Copy all shared proto files to shared location
   - Configure all modules to use shared location

3. **Disable Parallel Protobuf Compilation**
   ```xml
   <configuration>
       <checkStaleness>false</checkStaleness>
       <clearOutputDirectory>false</clearOutputDirectory>
       <protocArtifact>...</protocArtifact>
       <protocVersion>3.25.5</protocVersion>
   </configuration>
   ```

### **Long-term Solutions (Medium Priority):**

1. **Protobuf Module Consolidation**
   - Merge all protobuf generation into single module
   - Distribute generated classes as JAR dependencies

2. **Build Profile Optimization**
   - Create separate profiles for protobuf generation
   - Use profile activation to control build phases

3. **Dependency Management Enhancement**
   - Implement proper dependency versioning
   - Use Maven dependency management for protobuf artifacts

## Build Success Prediction

### **With Current Fixes:**
- ✅ **`mvn clean install -DskipTests`** - Should work with temporary file copying
- ⚠️ **`mvn clean install`** - May fail due to test dependencies on protobuf classes
- ❌ **Parallel builds** - Will likely fail due to file conflicts

### **With Recommended Solutions:**
- ✅ **`mvn clean install -DskipTests`** - Should work reliably
- ✅ **`mvn clean install`** - Should work with proper test configuration
- ✅ **Parallel builds** - Should work with shared protobuf directory

## Conclusion

The circular dependency issue is caused by **conflicts between dependency injection points and deletion/cleanup points** during the build process. The current fixes address the immediate symptoms but don't resolve the underlying architectural issue.

**Key Recommendations:**
1. **Upgrade protobuf-maven-plugin** to resolve cleanup issues
2. **Implement shared protobuf directory** to eliminate file conflicts
3. **Consider protobuf module consolidation** for long-term stability

The build order is correct, but the **protobuf file sharing mechanism** needs architectural improvement to prevent injection/deletion conflicts.